---
title: ""
author: ""           
output:
  html_document:
    css: css/style.css
    theme: paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F, cache = F
)
```

```{r libraries, warnings = F}
library(tidyverse)
library(leaflet)
library(leafpop)
library(leaflet.extras)
library(crosstalk)
library(sf)
library(htmlwidgets)
library(leaflegend)

```

```{r, results='hide'}
# import data

sxfer <- read_csv("clean_data/sxfer.csv") |> 
  filter(yr == 2023)

# add white circle markers for school settlement corporations

sxfer <- rbind(sxfer,
            # create row where the settlement corporation and the enrolled school corporation are the same so it appears as a transfer to itself but rather than having a type color equal to public, charter or choice scholarship, the color is white to more easily locate the school corporation
               sxfer |>
                 ungroup() |>
                 distinct(stlmt_corp_name, .keep_all = T) |>
                 mutate(nrl_schl_id = stlmt_corp_id,
                        nrl_schl_name = stlmt_corp_name,
                        nrl_lat = stlmt_lat,
                        nrl_lon = stlmt_lon,
                        tot_xfr = 0, # set to 0 to not alter total xfer count
                        fname = paste0(stlmt_corp_id, "-", stlmt_corp_id),
                        fillcolor = '#ffffff',
                        # stroke weight
                        weight = 1,
                        # stroke color
                        color = "#000000",
                        typ = 'Public',
                        pct_of_xfr = 0,
                        # add square root figure that reflects square root for average transfer size
                        log = 1.759581))
  
# make shared data object from sxfer dataframe
schl_data <- SharedData$new(data = sxfer)

# school corporation boundaries
in_dis <-
  st_read("clean_data/corp_geo.geojson",
          layer = "corp_geo.geojson")

```



```{r}
# url components for popups
base_url <- "https://tedschurter-data.s3.us-east-2.amazonaws.com/2024-in-ed-"
end_url <- ".png"

# add custom legend for outgoing transfer types; # basic structure from: stackoverflow.com/questions/58505589/circles-in-legend-for-leaflet-map-with-addcirclemarkers-in-r-without-shiny

# note: if argument is not listed within function(), can't call it later within leaflet

addLegendCustom <- function(map, colors, labels, sizes, title, position, group, opacity = 1, className ){
  
  colorAdditions <- paste0(colors, "; border-radius: 50%; width:", sizes, "px; height:", sizes, "px")
  
  labelAdditions <- paste0("<div style='display: inline-block;height: ", 
                           sizes, "px;margin-top: 4px;line-height: ", sizes, "px;'>", 
                           labels, "</div>")
  
  return(addLegend(map, 
                   colors = colorAdditions, 
                   labels = labelAdditions, 
                   opacity = opacity,
                   title = title, 
                   position = position, 
                   group = group
                   ))
}

map <-  
  leaflet(
    options = leafletOptions(
      minZoom = 6.8,
      maxZoom = 11),
    height = 500
  )|>
    
    setView(lng = -86.95, #-86.75, #-87.05, 
            lat = 39.8, 6) |>
    
    addProviderTiles(providers$CartoDB.Positron, ) |>
    
    
    # polygon layer to show corporation/district boundaries for outgoing layer
    addPolygons(data = in_dis,
                color = "black",
                  #"#111111",
                fillOpacity = .85,
                fillColor = '#f0f0f0', #"#ffffff",
                weight = .2,
                group = "Outgoing transfers"
    ) |>

    # add circle markers for outgoing transfers from school corporations
    addCircleMarkers (
      data = schl_data,
      ~ nrl_lon,
      ~ nrl_lat,
      radius =  ~log*4,
      fillColor = ~ fillcolor,
      color = ~ color,
      weight = ~weight,
      stroke = T,
      fillOpacity = .85,
      label = ~ nrl_schl_name,
      popup = popupImage(paste0(base_url, sxfer$fname, end_url),
                         width = 350, height = 467), # popup will not autopan on first click if height not explicitly set
      popupOptions =
        popupOptions(keepInView = TRUE,
                     autoPan = TRUE),
      # add grouping
      group = "Outgoing transfers"

    ) |>
  
    # reset button
    addResetMapButton() |>
 
    # custom legend outgoing transfers
    addLegendCustom(
      colors = 
        c(
          "#fc8d62",
          "#66c2a5",
          "#8da0cb"
        ),
      labels = 
        c('Public',
          'Charter',
          'Choice Scholarship'
        ),
      sizes = c(15, 15, 15), 
      position = "topleft", 
      title = 
        paste0("<span style='font-weight:600'>Outgoing transfers</span><br><span style='font-weight:100;font-size: 8pt; line-height: normal'>Select circles for transfer<br>details and test scores</span><br>\u25EF <span style='font-size: 10pt; font-weight:100'>School corporation</span><br><br><span style='font-weight:400; '>Enrolled school types:</span><br><span style='font-weight:100;font-size: 8pt; line-height: normal'>Circle sizes proportional <br>to transfer totals</span>"),
      group = "Outgoing transfers" 
    ) |>
    
    # javascript function to return map to default bounds if circle marker popup moves map beyond view
    onRender("function(el, x) {
                          var map = this;
                          map.eachLayer(function(layer) {
  
                            if(layer instanceof L.CircleMarker){
                              layer.on('click', function(e){
  
                                layer.getPopup().on('remove', function () {
  
                                  map.setView(map._initialCenter, map._initialZoom);
                                });
                              })
                              .addTo(map)
                            }
                          });
                        }
    ")  
  
 
```

```{r, filter}
# dropdown filter for school corporation of legal settlement
filter <-   
  filter_select(
    id = "filter_stlmt",
    label = "Select school corporation", 
    sharedData = schl_data,
    multiple = F,
    group = ~stlmt_corp_name, 
  )

```



```{r, out-filters}

filt <- list(filter 
             )
bscols(
  # set widths of respective elements; 12 column max available
  widths = c(2,10),
  filt, map)


```



```{js out-filter-select-nrl-map}

<!-- <!--   helpful js function to enable selecting default value in filter; from https://stackoverflow.com/questions/67058016/how-to-set-default-values-in-filter-select-in-crosstalk-in-r-plotly/68024136#68024136  --> -->


function filter_stlmt_corp() {
    document.getElementById("filter_stlmt").getElementsByClassName("selectized")
[0].selectize.setValue("Adams Central Community Schools",  false);
 }

window.onload=function(){
filter_stlmt_corp()
}
```

